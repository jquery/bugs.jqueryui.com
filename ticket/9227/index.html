<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-pagefind-meta="title">#9227 (Poor Performance of animateClass with children - 500 elements &amp;gt; 1 second pause) - jQuery UI - Bug Tracker</title>
    <meta name="description" content="Static archive of the old bugs.jqueryui.com Trac site.">
    
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    
    
    
    
    
    
    <link rel="stylesheet" href="/bundle/u10aUuj4Q4.css">
  </head>
  <body>
    <div class="banner flex-center">
      <span>jQuery UI issues have moved to <a href="https://github.com/jquery/jquery-ui/issues">GitHub</a>. This site is now a static archive of the old <a href="https://trac.edgewall.org/">Trac</a> bugs site. <br>Some functions and pages are no longer available.</span>
    </div>
    <div class="container">
      <a href="#skip" class="visually-hidden">Skip to main content</a>
      <header class="flex-column">
        <div class="flex-row flex-between-start">
          <a id="jq-siteLogo" href="/" title="jQuery UI Bugs Home">
            <img src="/img/logo.svg" width="253" alt="jQuery UI">
          </a>
          <input class="hamburger-toggle visually-hidden" id="jq-menutoggle" type="checkbox">
          <label aria-label="Toggle Menu" for="jq-menutoggle" class="hamburger-lines flex-column flex-between-center">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </label>
          <div id="jq-menus" class="flex-column">
            <nav id="jq-primaryNavigation">
              <h2 class="visually-hidden">jQuery UI sites navigation menu</h2>
              <ul class="nav">
                <li class="jq-jquery">
                  <a href="https://jquery.com/" title="jQuery Home">jQuery</a>
                </li>
                <li class="jq-plugins">
                  <a href="https://plugins.jquery.com/" title="jQuery Plugins">Plugins</a>
                </li>
                <li class="jq-ui active">
                  <a href="https://jqueryui.com/" title="jQuery UI">UI</a>
                </li>
                <li class="jq-meetup">
                  <a href="https://meetups.jquery.com/" title="jQuery Meetups">Meetups</a>
                </li>
                <li class="jq-forum">
                  <a href="https://forum.jquery.com/" title="jQuery Forum">Forum</a>
                </li>
                <li class="jq-blog">
                  <a href="https://blog.jquery.com/" title="jQuery Blog">Blog</a>
                </li>
                <li class="jq-about">
                  <a href="https://openjsf.org" title="About jQuery and OpenJS">About</a>
                </li>
                <li class="jq-donate">
                  <a href="https://openjsf.org/about/project-funding-opportunities/" title="Donate to OpenJS">Donate</a>
                </li>
              </ul>
            </nav>
            <nav id="jq-secondaryNavigation">
              <h2 class="visually-hidden">jQuery UI navigation menu</h2>
              <ul class="nav">
                <li class="jq-download">
                  <a href="https://jqueryui.com/download/">
                    Download
                  </a>
                </li>
                <li class="jq-documentation">
                  <a href="https://jqueryui.com/demos/">
                    Demos &amp; Documentation
                  </a>
                </li>
                <li class="jq-themes">
                  <a href="https://jqueryui.com/themeroller/">
                    Themes
                  </a>
                </li>
                <li class="jq-development">
                  <a href="https://jqueryui.com/development/">
                    Development
                  </a>
                </li>
                <li class="jq-support">
                  <a href="https://jqueryui.com/support/">
                    Support
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </header>
      <main id="skip" class="flex-column white-box">
        <h2 class="visually-hidden">Search and Top Navigation</h2>
        <div class="flex-row flex-end-center">
          <div id="search"></div>
        </div>
        <nav id="jq-topnav" class="flex-column flex-start-center">
          <a href="/newticket">New Ticket</a>
          <a href="/report">View Tickets</a>
          <a href="/ticketgraph">Ticket Graph</a>
          <a href="/roadmap">Roadmap</a>
          <a href="/timeline">Recent Changes</a>
        </nav>
        <div id="jq-content" class="flex-column">
          

<div class="flex-column" data-pagefind-body="">
  

  <nav class="content-nav">
    <ul class="flex-row">
      
        <li>
          <a href="/ticket/9226/">← Previous Ticket</a>
        
      
      
        </li><li>
          <a href="/ticket/9228/">Next Ticket →</a>
        </li>
      
    </ul>
  </nav>


<div class="ticket-info">
  <div class="flex-row flex-between-start">
    <h2>
      <a href="" class="ticket-number">#9227</a>
      <span class="ticket-status">closed</span>
      <span class="ticket-type">bug</span>
      <span class="ticket-resolution">(duplicate)</span>
    </h2>

    <div class="ticket-dates">
      <p>Opened April 12, 2013 03:48PM UTC</p>
      
        <p>Closed April 12, 2013 03:51PM UTC</p>
      
      
        <p>Last modified April 18, 2013 02:07AM UTC</p>
      
    </div>
  </div>

  <h1 class="ticket-title">Poor Performance of animateClass with children - 500 elements &gt; 1 second pause</h1>

  <table class="ticket-properties">
    <tr>
      <th>Reported by:</th>
      <td>
        BenEllis
      </td>
      <th>Owned by:</th>
      <td></td>
    </tr>
    <tr>
      <th>
        Priority:
      </th>
      <td>
        minor
      </td>
      
        <th class="missing">Milestone:</th>
      
      <td>
        <a href="/milestone/none">none</a>
      </td>
    </tr>
    <tr>
      <th>Component:</th>
      <td>ui.effects.core</td>
      
        <th>Version:</th>
      
      <td>1.10.2</td>
    </tr>
    <tr>
      
        <th class="missing">Keywords:</th>
      
      <td></td>
      
        <th class="missing">Cc:</th>
      
      <td></td>
    </tr>
    <tr>
      <th class="missing">
        Blocked by:
      </th>
      <td></td>
      <th class="missing">
        Blocking:
      </th>
      <td></td>
    </tr>
  </table>
  <div class="ticket-info-bottom">
    <h5 class="ticket-description-title">Description</h5>
    <div class="ticket-description"><p>My use case is I'm displaying a conversation history (100s - 1000s of lines) and the user wants the ability to minimize, restore and maximize the view. Other controls inside the container change size.</p><p>Below is a contrived example of what I'm trying to achieve,</p><p> <a href="http://jsfiddle.net/BenEllis/4Gwe9/3/" class="ext-link"><span class="icon"></span>http://jsfiddle.net/BenEllis/4Gwe9/3/</a></p><p>When using</p><pre class="wiki">
$('div.outer').addClass('myanimatedclass', {
    children: true,
    duration: 1000
});
</pre><p>if div.outer has many  children the performance is slow. Could the performance be improved by using the CSS rules to build a selector of children that would be affected by the classes being added / removed?</p></div>
  </div>
</div>

<details>
  <summary class="ticket-details-summary">Attachments (0)</summary>

  <ul class="ticket-attachments">
    
  </ul>
</details>

<details open="">
  <summary class="ticket-details-summary">Change History (5)</summary>
  
    <div class="ticket-change flex-column" id="comment:1">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed April 12, 2013 03:51PM UTC by <span class="author">scottgonzalez</span></span>
        <a class="ticket-change-link" href="#comment:1">comment:1</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
              
                <tr>
                  <th>resolution:</th>
                  <td>
                    
                      <span class="change-field-new">→ duplicate</span>
                    
                  </td>
                </tr>
              
            
              
                <tr>
                  <th>status:</th>
                  <td>
                    
                      <span class="change-field-old">new</span> → <span class="change-field-new">closed</span>
                    
                  </td>
                </tr>
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Duplicate of <a href="/ticket/9226">#9226</a>.You've presented the exact same fiddle and use case as before. This seems like a bad example. For instance, the fact that you want to hide the input isn't really tied to how that should animate.  Please don't intentionally create duplicate tickets.</p>
            </div>
          
        
          
        
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:2">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed April 12, 2013 04:37PM UTC by <span class="author">BenEllis</span></span>
        <a class="ticket-change-link" href="#comment:2">comment:2</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
                <tr>
                  <th>_comment0:</th>
                  <td>
                    
                      <span class="change-field-old">Why does a performance issue require a use-case for a feature that already exists? I would have thought having 100+ child elements in fairly common?&#92;
&#92;
I&#39;ve done an initial working implementation to address the performance problem, it only selects children affected by the change of the classes before getting all the styles. This has really improved the performance when there are &gt;100 children.&#92;
&#92;
This works perfectly for me (IE9, FF 20.0.1, Chrome 26.0.1410.64 m), though there may be a few bugs for use-cases I&#39;ve not considered.&#92;
&#92;
I&#39;ve manually parsed the CSS rules (I&#39;m guessing there is a better selector or helper methods in jQuery that would do a better job than I&#39;ve done).&#92;
&#92;
&#92;
{{{&#92;
$.effects.animateClass = function( value, duration, easing, callback ) {&#92;
	var o = $.speed( duration, easing, callback );&#92;
&#92;
	return this.queue(function () {&#92;
	    &#92;
	    var getSelectors = function () {&#92;
	        var retVal = &#39;&#39;;&#92;
	        $.each(classAnimationActions, function (i, action) {&#92;
	            if (value[action]) {&#92;
	                var classNames = value[action].match(/[^,]+(?=,)|[^,]+(?=$)/gim);&#92;
	                $.each(classNames, function (i, className) {&#92;
	                    var sheets = document.styleSheets;&#92;
	                    for (var sheetIndex in sheets) {&#92;
	                        var rules = sheets[sheetIndex].rules || sheets[sheetIndex].cssRules;&#92;
	                        for (var r in rules) {&#92;
	                            if (rules[r].type == window.CSSRule.STYLE_RULE &amp;&amp; rules[r].selectorText.indexOf(&quot;.&quot; + className) != -1) {&#92;
	                                var currentrule = rules[r].selectorText;&#92;
	                                currentrule = currentrule.substring(currentrule.indexOf(&quot;.&quot; + className) + (&quot;.&quot; + className).length);&#92;
	                                currentrule = /[^) ].*/gim.exec(currentrule);&#92;
	                                if (currentrule) {&#92;
	                                    retVal = retVal + &#39;,&#39; + currentrule;&#92;
	                                }&#92;
	                            }&#92;
	                        }&#92;
	                    }&#92;
	                });&#92;
	            }&#92;
	        });&#92;
	        &#92;
	        return retVal.substring(1);&#92;
	    }; &#92;
	    &#92;
		var animated = $( this ),&#92;
			baseClass = animated.attr( &quot;class&quot; ) || &quot;&quot;,&#92;
			applyClassChange,&#92;
	        allAnimations = o.children ? animated.find(getSelectors()).addBack() : animated;&#92;
&#92;
		// map the animated objects to store the original styles.&#92;
		allAnimations = allAnimations.map(function() {&#92;
			var el = $( this );&#92;
			return {&#92;
				el: el,&#92;
				start: getElementStyles( this )&#92;
			};&#92;
		});&#92;
&#92;
		// apply class change&#92;
		applyClassChange = function() {&#92;
			$.each( classAnimationActions, function(i, action) {&#92;
				if ( value[ action ] ) {&#92;
					animated[ action + &quot;Class&quot; ]( value[ action ] );&#92;
				}&#92;
			});&#92;
		};&#92;
		applyClassChange();&#92;
&#92;
		// map all animated objects again - calculate new styles and diff&#92;
		allAnimations = allAnimations.map(function() {&#92;
			this.end = getElementStyles( this.el[ 0 ] );&#92;
			this.diff = styleDifference(this.start, this.end);&#92;
			return this;&#92;
		});&#92;
&#92;
		// apply original class&#92;
		animated.attr( &quot;class&quot;, baseClass );&#92;
&#92;
		// map all animated objects again - this time collecting a promise&#92;
		allAnimations = allAnimations.map(function () {&#92;
		    if (this.diff != {}) {&#92;
		        var styleInfo = this,&#92;
		            dfd = $.Deferred(),&#92;
		            opts = $.extend({}, o, {&#92;
		                queue: false,&#92;
		                complete: function() {&#92;
		                    dfd.resolve(styleInfo);&#92;
		                }&#92;
		            });&#92;
&#92;
		        this.el.animate(this.diff, opts);&#92;
		        return dfd.promise();&#92;
		    }&#92;
		});&#92;
&#92;
		// once all animations have completed:&#92;
		$.when.apply( $, allAnimations.get() ).done(function() {&#92;
&#92;
			// set the final class&#92;
			applyClassChange();&#92;
&#92;
			// for each animated element,&#92;
			// clear all css properties that were animated&#92;
			$.each( arguments, function() {&#92;
				var el = this.el;&#92;
				$.each( this.diff, function(key) {&#92;
					el.css( key, &quot;&quot; );&#92;
				});&#92;
			});&#92;
&#92;
			// this is guarnteed to be there if you use jQuery.speed()&#92;
			// it also handles dequeuing the next anim...&#92;
			o.complete.call( animated[ 0 ] );&#92;
		});&#92;
	});&#92;
};&#92;
}}}</span> → <span class="change-field-new">1365784782392438</span>
                    
                  </td>
                </tr>
              
            
              
            
          </tbody>
        </table>
        
          
        
          
            <div class="ticket-comment-body">
              <p>Why does a performance issue require a use-case for a feature that already exists? I would have thought having 100+ child elements in fairly common?</p><p>I've done an initial working implementation to address the performance problem, it only selects children affected by the change of the classes before getting all the styles. This has really improved the performance when there are &gt;100 children.</p><p>This works perfectly for me (IE9, FF 20.0.1, Chrome 26.0.1410.64 m), though there may be a few bugs for CSS rules I've not considered as I've manually parsed the CSS rules. I'm guessing there is a better selector or helper methods in jQuery that would do a better job than I've done.</p><pre class="wiki">
$.effects.animateClass = function( value, duration, easing, callback ) {
	var o = $.speed( duration, easing, callback );

	return this.queue(function () {
	    
	    var getSelectors = function () {
	        var retVal = '';
	        $.each(classAnimationActions, function (i, action) {
	            if (value[action]) {
	                var classNames = value[action].match(/[^,]+(?=,)|[^,]+(?=$)/gim);
	                $.each(classNames, function (i, className) {
	                    var sheets = document.styleSheets;
	                    for (var sheetIndex in sheets) {
	                        var rules = sheets[sheetIndex].rules || sheets[sheetIndex].cssRules;
	                        for (var r in rules) {
	                            if (rules[r].type == window.CSSRule.STYLE_RULE && rules[r].selectorText.indexOf("." + className) != -1) {
	                                var currentrule = rules[r].selectorText;
	                                currentrule = currentrule.substring(currentrule.indexOf("." + className) + ("." + className).length);
	                                currentrule = /[^) ].*/gim.exec(currentrule);
	                                if (currentrule) {
	                                    retVal = retVal + ',' + currentrule;
	                                }
	                            }
	                        }
	                    }
	                });
	            }
	        });
	        
	        return retVal.substring(1);
	    }; 
	    
		var animated = $( this ),
			baseClass = animated.attr( "class" ) || "",
			applyClassChange,
	        allAnimations = o.children ? animated.find(getSelectors()).addBack() : animated;

		// map the animated objects to store the original styles.
		allAnimations = allAnimations.map(function() {
			var el = $( this );
			return {
				el: el,
				start: getElementStyles( this )
			};
		});

		// apply class change
		applyClassChange = function() {
			$.each( classAnimationActions, function(i, action) {
				if ( value[ action ] ) {
					animated[ action + "Class" ]( value[ action ] );
				}
			});
		};
		applyClassChange();

		// map all animated objects again - calculate new styles and diff
		allAnimations = allAnimations.map(function() {
			this.end = getElementStyles( this.el[ 0 ] );
			this.diff = styleDifference(this.start, this.end);
			return this;
		});

		// apply original class
		animated.attr( "class", baseClass );

		// map all animated objects again - this time collecting a promise
		allAnimations = allAnimations.map(function () {
		    if (this.diff != {}) {
		        var styleInfo = this,
		            dfd = $.Deferred(),
		            opts = $.extend({}, o, {
		                queue: false,
		                complete: function() {
		                    dfd.resolve(styleInfo);
		                }
		            });

		        this.el.animate(this.diff, opts);
		        return dfd.promise();
		    }
		});

		// once all animations have completed:
		$.when.apply( $, allAnimations.get() ).done(function() {

			// set the final class
			applyClassChange();

			// for each animated element,
			// clear all css properties that were animated
			$.each( arguments, function() {
				var el = this.el;
				$.each( this.diff, function(key) {
					el.css( key, "" );
				});
			});

			// this is guarnteed to be there if you use jQuery.speed()
			// it also handles dequeuing the next anim...
			o.complete.call( animated[ 0 ] );
		});
	});
};
</pre>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:3">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed April 12, 2013 05:05PM UTC by <span class="author">scottgonzalez</span></span>
        <a class="ticket-change-link" href="#comment:3">comment:3</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Replying to [comment:2 <a href="/wiki/BenEllis">BenEllis</a>]:</p><blockquote> Why does a performance issue require a use-case for a feature that already exists? I would have thought having 100+ child elements in fairly common?</blockquote><p>Because if it's not something people are doing for real, or it's not something people *should* be doing, then it doesn't matter how poorly it performs.</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:4">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed April 15, 2013 08:40AM UTC by <span class="author">BenEllis</span></span>
        <a class="ticket-change-link" href="#comment:4">comment:4</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>I am using this in a real commercial project. Why shouldn't I be doing it?</p>
            </div>
          
        
      </div>
    </div>
  
    <div class="ticket-change flex-column" id="comment:5">
      <h3 class="flex-row flex-between-start ticket-change-header">
        <span>Changed April 18, 2013 02:07AM UTC by <span class="author">tj.vantoll</span></span>
        <a class="ticket-change-link" href="#comment:5">comment:5</a>
      </h3>

      <div class="ticket-change-content">
        <table class="ticket-changes">
          <tbody>
            
              
            
          </tbody>
        </table>
        
          
            <div class="ticket-comment-body">
              <p>Replying to [comment:4 <a href="/wiki/BenEllis">BenEllis</a>]:</p><blockquote> I am using this in a real commercial project. Why shouldn't I be doing it?</blockquote><p>Simultaneously animating hundreds of elements is a bad idea.  There's only so much the CPU can handle and there are better (and far less resource intensive) ways of accomplishing the same effect.  If you need further support try <a href="http://irc.jquery.org/" class="ext-link"><span class="icon"></span>#jquery on Freenode</a>, the <a href="http://forum.jquery.com/" class="ext-link"><span class="icon"></span>forums</a>, or <a href="http://stackoverflow.com/questions/tagged/jquery-ui" class="ext-link"><span class="icon"></span>Stack Overflow</a>.</p>
            </div>
          
        
      </div>
    </div>
  
</details>
</div>
        </div>
      </main>
      <footer>
        Copyright &copy; 2024
        <a href="https://openjsf.org">The OpenJS Foundation</a>
      </footer>
    </div>
    <script src="/pagefind/pagefind-ui.js" type="text/javascript"></script>
  </body>
</html>
